%                      Code_Saturne version 1.3
%                      ------------------------
%
%     This file is part of the Code_Saturne Kernel, element of the
%     Code_Saturne CFD tool.
%
%     Copyright (C) 1998-2007 EDF S.A., France
%
%     contact: saturne-support@edf.fr
%
%     The Code_Saturne Kernel is free software; you can redistribute it
%     and/or modify it under the terms of the GNU General Public License
%     as published by the Free Software Foundation; either version 2 of
%     the License, or (at your option) any later version.
%
%     The Code_Saturne Kernel is distributed in the hope that it will be
%     useful, but WITHOUT ANY WARRANTY; without even the implied warranty
%     of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.
%
%     You should have received a copy of the GNU General Public License
%     along with the Code_Saturne Kernel; if not, write to the
%     Free Software Foundation, Inc.,
%     51 Franklin St, Fifth Floor,
%     Boston, MA  02110-1301  USA
%
%-----------------------------------------------------------------------
%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Mise en \oe uvre}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Le syst\`eme (\ref{Cfbl_Cfmsvl_eq_densite_finale_cfmsvl}) est r\'esolu par une m\'ethode
d'incr\'ement et r\'esidu en utilisant
une m\'ethode de Jacobi pour inverser le syst\`eme si le terme convectif
est implicite et en utilisant une m\'ethode de gradient conjugu\'e
si le terme convectif est explicite (qui est le cas par défaut).

Attention, les valeurs du flux de masse $\rho\,\vect{w}\cdot\vect{S}$ et
de la viscosit\'e $\Delta\,t\,c^2\frac{S}{d}$ aux faces de
bord, qui sont calcul\'ees dans \fort{cfmsfl} et \fort{cfmsvs} respectivement,
sont modifi\'ees imm\'ediatement apr\`es l'appel \`a ces sous-programmes.
En effet, il est indispensable que la contribution de bord de
$\left(\rho\,\vect{w}-\Delta\,t\,(c^2)\,\gradv\,\rho\right)\cdot\vect{S}$
repr\'esente exactement $\vect{Q}_{ac}\cdot\vect{S}$.
Pour cela,
\begin{itemize}
\item imm\'ediatement apr\`es l'appel \`a
\fort{cfmsfl}, on remplace la contribution de bord de
$\rho\,\vect{w}\cdot\vect{S}$
par le flux de masse exact, $\vect{Q}_{ac}\cdot\vect{S}$,
d\'etermin\'e \`a partir des conditions aux limites,
\item puis, imm\'ediatement apr\`es l'appel \`a
\fort{cfmsvs}, on annule la viscosit\'e au bord $\Delta\,t\,(c^2)$ pour
\'eliminer la contribution de $-\Delta\,t\,(c^2)\,(\gradv\,\rho)\cdot\vect{S}$
(l'annulation de la viscosit\'e n'est pas probl\'ematique pour la matrice,
puisqu'elle porte sur des incr\'ements).
\end{itemize}

\bigskip

Une fois qu'on a obtenu $\rho^{n+1}$,
on peut actualiser le flux de masse acoustique
aux faces $(\vect{Q}_{ac}^{n+1})_{ij} \cdot \vect{S}_{ij}$,
qui servira pour la convection des autres variables~:
\begin{equation}\label{Cfbl_Cfmsvl_eq_flux_masse_acoustique_cfmsvl}
\displaystyle(\vect{Q}_{ac}^{n+1})_{ij}\cdot\vect{S}_{ij}=
-\left(\Delta t^n (c^2)^n \gradv(\rho^{n+1})\right)_{ij}\cdot\vect{S}_{ij}
+\left(\rho^{n+\frac{1}{2}} \vect{w}^n\right)_{ij}\cdot\vect{S}_{ij}\\
\end{equation}
Ce calcul de flux est r\'ealis\'e par \fort{cfbsc3}.
Si l'on a choisi l'algorithme standard, \'equation~(\ref{Cfbl_Cfmsvl_eq_densite_cfmsvl}),
on compl\`ete le flux dans \fort{cfmsvl} imm\'ediatement apr\`es l'appel
\`a \fort{cfbsc3}.
En effet, dans ce cas,
la convection est explicite ($\rho^{n+\frac{1}{2}}=\rho^{n}$,
obtenu en imposant \var{ICONV(ISCA(IRHO(IPHAS)))=0})
et le sous-programme \fort{cfbsc3},
qui calcule le flux de masse aux faces,
ne prend pas en compte la contribution du terme
$\rho^{n+\frac{1}{2}}\,\vect{w}^n\cdot\vect{S}$. On ajoute donc cette
contribution dans \fort{cfmsvl}, apr\`es l'appel \`a \fort{cfbsc3}.
Au bord, en particulier, c'est bien le flux de masse calcul\'e \`a partir
des conditions aux limites que l'on obtient.

On actualise la pression \`a la fin de l'\'etape, en utilisant la loi d'\'etat~:
\begin{equation}
\displaystyle P_i^{pred}=P(\rho_i^{n+1},\varepsilon_i^{n})
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Points \`a traiter}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Le calcul du flux de masse au  bord n'est pas enti\`erement satisfaisant
si la convection est trait\'ee de mani\`ere implicite
(algorithme non standard, non test\'e,
associ\'e \`a l'\'equation~(\ref{Cfbl_Cfmsvl_eq_densite_bis_cfmsvl}),
correspondant au choix $\rho^{n+\frac{1}{2}}=\rho^{n+1}$ et
obtenu en imposant \var{ICONV(ISCA(IRHO(IPHAS)))=1}).
En effet, apr\`es \fort{cfmsfl}, il faut d\'eterminer la vitesse de
convection $\vect{w}^n$ pour qu'apparaisse
$\rho^{n+1} \vect{w}^n\cdot\vect{n}$
au cours de la r\'esolution par \fort{codits}. De ce fait, on doit d\'eduire
une valeur de $\vect{w}^n$ \`a partir de la valeur
du flux de masse. Au bord, en particulier, il faut
donc diviser le flux de masse
issu des conditions aux limites par la valeur de bord de $\rho^{n+1}$.
Or, lorsque des conditions de Neumann sont appliqu\'ees \`a la
masse volumique,
la valeur de $\rho^{n+1}$ au bord n'est pas connue avant la r\'esolution du
syst\`eme. On utilise donc, au lieu de la valeur de bord inconnue de
$\rho^{n+1}$ la valeur de bord prise au pas de temps
pr\'ec\'edent $\rho^{n}$. Cette approximation est susceptible
d'affecter la valeur du flux de masse au bord.
